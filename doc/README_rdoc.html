<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>README - RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body class="file">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./BUILD.html">BUILD</a>
  
    <li class="file"><a href="./Gemfile.html">Gemfile</a>
  
    <li class="file"><a href="./README_rdoc.html">README</a>
  
    <li class="file"><a href="./Rakefile.html">Rakefile</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./Wfe.html">Wfe</a>
  
    <li><a href="./Wfe/BaseStep.html">Wfe::BaseStep</a>
  
    <li><a href="./Wfe/Engine.html">Wfe::Engine</a>
  
    <li><a href="./Wfe/ErrorState.html">Wfe::ErrorState</a>
  
    <li><a href="./Wfe/Exception.html">Wfe::Exception</a>
  
    <li><a href="./Wfe/Lock.html">Wfe::Lock</a>
  
    <li><a href="./Wfe/LockMigration.html">Wfe::LockMigration</a>
  
    <li><a href="./Wfe/StepError.html">Wfe::StepError</a>
  
    <li><a href="./Wfe/Steps.html">Wfe::Steps</a>
  
    <li><a href="./Wfe/Steps/ColabDummy.html">Wfe::Steps::ColabDummy</a>
  
    <li><a href="./Wfe/Steps/Dummy.html">Wfe::Steps::Dummy</a>
  
    <li><a href="./Wfe/Steps/Error.html">Wfe::Steps::Error</a>
  
    <li><a href="./Wfe/Steps/RunOnRemoteHosts.html">Wfe::Steps::RunOnRemoteHosts</a>
  
    <li><a href="./Wfe/Workflow.html">Wfe::Workflow</a>
  
    <li><a href="./Wfe/WorkflowHalted.html">Wfe::WorkflowHalted</a>
  
    <li><a href="./Wfe/WorkflowLocked.html">Wfe::WorkflowLocked</a>
  
    <li><a href="./Wfe/WorkflowMIA.html">Wfe::WorkflowMIA</a>
  
    <li><a href="./Wfe/WorkflowMigration.html">Wfe::WorkflowMigration</a>
  
    <li><a href="./Wfe/WorkflowStep.html">Wfe::WorkflowStep</a>
  
    <li><a href="./Wfe/WorkflowStepMigration.html">Wfe::WorkflowStepMigration</a>
  
    <li><a href="./WorkflowEngine.html">WorkflowEngine</a>
  
    <li><a href="./WorkflowEngine/ColabDummy.html">WorkflowEngine::ColabDummy</a>
  
    <li><a href="./WorkflowEngine/Dummy.html">WorkflowEngine::Dummy</a>
  
    <li><a href="./WorkflowEngine/DummySTDOUT.html">WorkflowEngine::DummySTDOUT</a>
  
    <li><a href="./BuildApp.html">BuildApp</a>
  
    <li><a href="./ErrorStep.html">ErrorStep</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./PushApp.html">PushApp</a>
  
    <li><a href="./RunShell.html">RunShell</a>
  
    <li><a href="./StartApp.html">StartApp</a>
  
    <li><a href="./StartAppX.html">StartAppX</a>
  
    <li><a href="./StopApp.html">StopApp</a>
  
    <li><a href="./StopAppX.html">StopAppX</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation" class="description">
  
<h1 id="label-WFE+-+Persisted+Workflow+Engine">WFE - Persisted Workflow Engine</h1>

<h4 id="label-Features">Features</h4>
<ul><li>
<p>Sequential step by step execution</p>
</li><li>
<p>Pause on step error</p>
</li><li>
<p>Can define custom step, or use generic step [TODO]</p>
</li><li>
<p>Ability to restart failed steps [TODO]</p>
</li><li>
<p>Ability to delete the workflow in error</p>
</li><li>
<p>Ability to force pause after current step [TODO]</p>
</li><li>
<p>Ability to force stop [TODO]</p>
</li><li>
<p>Workflow is persisted along with its step states in a database</p>
</li><li>
<p>Steps can share data through a workflow run time context</p>
</li></ul>

<h2 id="label-Overview">Overview</h2>

<p>A workflow (Workflow) consist of a sequence of steps (WorkflowStep). Each
steps includes the name of the class implementing the steps and other
attributes such as the state. THe class implementing the step should extend
BaseStep.</p>

<p>The work flow engine (Engine) abstracts some of the creational and
behavioral patterns, such as creation of workflows, workflow steps, and
their storage to a database.  The workflow engine is built on top of
ActiveRecord, hence supports various DB in theory. In practice, some
classes like Lock use mysql specific locking syntax and might not work with
other DBMS.</p>

<h2 id="label-Getting+Started">Getting Started</h2>

<h3 id="label-Dev+Setup">Dev Setup</h3>

<p>Get the source:</p>

<pre>svn co https://</pre>

<p>install gem dependencies, by running bundle in your working copy:</p>

<pre>bundle install</pre>

<p>Edit conf/db_conf.yml to your database settings. For exmaple:</p>

<pre>test:
  adapter: &quot;mysql2&quot;
  host: &quot;127.0.0.1&quot;
  username: &quot;root&quot;
  password: &quot;password&quot;
  database: &quot;wfe_test&quot;
prod:
  adapter: &quot;mysql2&quot;
  host: &quot;127.0.0.1&quot;
  username: &quot;root&quot;
  password: &quot;p4ssVV0rd
  database: &quot;wfe&quot;</pre>

<p>Create the databases:</p>

<pre>mysql -uroot -punlock -h127.0.0.1 -e 'create database wfe_test; create database wfe';</pre>

<p>Setup your test database:</p>

<pre>rake db_setup_test_database</pre>

<p>Run rpsecs:</p>

<pre>rake rspec</pre>

<p>build and install gem:</p>

<pre>gem build wfe.gemspec &amp;&amp; gem install ./wfe-0.0.0.gem</pre>

<h2 id="label-Usage+Example">Usage Example</h2>

<p>These are the usual steps in creating and executing a workflow:</p>
<ul><li>
<p>implement your custom WorkflowStep(s)</p>
</li><li>
<p>instantiate an Engine</p>
</li><li>
<p>create and save a Workflow identified by an unique workflow name</p>
</li><li>
<p>execute workflow identified by a workflow name</p>
</li></ul>

<h4 id="label-Implementing+Custom+Steps">Implementing Custom Steps</h4>

<p>You can either use generic step implementation [TODO], or implement your
own steps. To implement your own step, you should define a class that
extends BaseStep and its methods. For example:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">RunShell</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Wfe</span><span class="ruby-operator">::</span><span class="ruby-constant">BaseStep</span>
 <span class="ruby-keyword">def</span> <span class="ruby-identifier">work</span>(<span class="ruby-identifier">ctx</span>)
   <span class="ruby-identifier">raise</span> <span class="ruby-constant">Exception</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;cannot find the maintenance cmd in the context!&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">ctx</span>[:<span class="ruby-identifier">maint_cmd</span>].<span class="ruby-identifier">nil?</span>
   <span class="ruby-identifier">ctx</span>[:<span class="ruby-identifier">stopped_servers</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;Running the maintenance on %s!\n&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">s</span>]
       <span class="ruby-identifier">abort</span> <span class="ruby-identifier">hte</span> <span class="ruby-identifier">workflow</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">a</span> <span class="ruby-identifier">command</span> <span class="ruby-identifier">is</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">run</span> <span class="ruby-identifier">successfully</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">Exception</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;cmd failed!&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">system</span>(<span class="ruby-identifier">ctx</span>[:<span class="ruby-identifier">maint_cmd</span>])
    <span class="ruby-keyword">end</span>
 <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The method work is the BaseStep method that should be overriden. ‘ctx’ is a
hash like structure that is past from one step to another during the
execution workflow. It contains arguments of the workflow, and anything
that needs to be shared among steps. Note that to halt the workflow
execution, raise an Exception.</p>

<h4 id="label-Engine+Instantiation">Engine Instantiation</h4>

<p>You need to pass the db config and options to the Engine contructor.</p>

<pre class="ruby"><span class="ruby-identifier">opts</span> = {
    :<span class="ruby-identifier">logger</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Logger</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;/var/log/mktoutils/test.log&quot;</span>),
}
<span class="ruby-identifier">db_conf</span> = {
    :<span class="ruby-identifier">adapter</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;mysql2&quot;</span>,
    :<span class="ruby-identifier">host</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;127.0.0.1&quot;</span>,
    :<span class="ruby-identifier">username</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;root&quot;</span>,
    :<span class="ruby-identifier">password</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;unlock&quot;</span>,
    :<span class="ruby-identifier">database</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;test&quot;</span>
}

<span class="ruby-identifier">wfe</span> = <span class="ruby-constant">Wfe</span><span class="ruby-operator">::</span><span class="ruby-constant">Engine</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">db_conf</span>, <span class="ruby-identifier">opts</span>)
</pre>

<p>Options that are currently supported:</p>

<pre>:logger : instance of core Logger.</pre>

<h4 id="label-Create+And+Save+A+Workflow">Create And Save A Workflow</h4>

<p>Let’s say we have implemented 3 custom step, <a
href="StopAppX.html">StopAppX</a>, RunCmd, <a
href="StartAppX.html">StartAppX</a>.</p>

<pre class="ruby"><span class="ruby-comment"># define the sequence of steps, steps are Classes which extends BaseStep</span>
<span class="ruby-identifier">server_maintenance</span> = [ <span class="ruby-constant">StopAppX</span>, <span class="ruby-constant">RunCmd</span>, <span class="ruby-constant">StartAppX</span>]

<span class="ruby-comment">#arguments that should be in the context of the workflow at init time</span>
<span class="ruby-comment"># i.e. required by some steps</span>

<span class="ruby-identifier">init_time_ctx</span> = {
    :<span class="ruby-identifier">cmd_to_run</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'mv /opt/app/logs/*.log /dev/null #who cares about logs right'</span>,
    :<span class="ruby-identifier">target_servers</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-string">'intweb1'</span>, <span class="ruby-string">'intweb2'</span>, <span class="ruby-string">'intbe1'</span>, <span class="ruby-string">'intbe2'</span>]
}

<span class="ruby-comment"># create the workflow, and save it</span>
<span class="ruby-identifier">wf</span> = <span class="ruby-identifier">wfe</span>.<span class="ruby-identifier">create_workflow</span>(<span class="ruby-string">'my_workflow'</span>,<span class="ruby-identifier">init_time_ctx</span>,<span class="ruby-identifier">server_maintenance</span>)
</pre>

<p>Note that we named out workflow ‘my_workflow’. THis will be used later on
whenever we need to load a workflow. This name should be unique, an
exception will be thrown if it’s not.</p>

<h4 id="label-Workflow+Execution">Workflow Execution</h4>

<p>We load a workflow by name, and call run:</p>

<pre class="ruby"><span class="ruby-keyword">begin</span>
  <span class="ruby-identifier">wfe</span>.<span class="ruby-identifier">run</span>(<span class="ruby-identifier">wf_name</span>)
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">Wfe</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>=<span class="ruby-operator">&gt;</span><span class="ruby-identifier">e</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;unknown exception: %s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">e</span>.<span class="ruby-identifier">to_s</span>]
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">Wfe</span><span class="ruby-operator">::</span><span class="ruby-constant">WorkflowHalted</span>=<span class="ruby-operator">&gt;</span><span class="ruby-identifier">e</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;workflow halted: %s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">e</span>.<span class="ruby-identifier">to_s</span>]
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">Wfe</span><span class="ruby-operator">::</span><span class="ruby-constant">StepError</span>=<span class="ruby-operator">&gt;</span><span class="ruby-identifier">e</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;step error: %s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">e</span>.<span class="ruby-identifier">to_s</span>]
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">Wfe</span><span class="ruby-operator">::</span><span class="ruby-constant">WorkflowLocked</span>=<span class="ruby-operator">&gt;</span><span class="ruby-identifier">e</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;workflow locked: %s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">e</span>.<span class="ruby-identifier">to_s</span>]
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">Wfe</span><span class="ruby-operator">::</span><span class="ruby-constant">ErrorState</span>=<span class="ruby-operator">&gt;</span><span class="ruby-identifier">e</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;workflow in error state: %s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">e</span>.<span class="ruby-identifier">to_s</span>]
<span class="ruby-keyword">end</span>
</pre>

</div>



<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.2.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

